name: üõ†Ô∏è Generate API on Master

on:
  # 1. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ –≤ 'master'
  # (–û–±—ã—á–Ω–æ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –º–µ—Ä–∂–∞ PR)
  push:
    branches:
      - develop

permissions:
  contents: write

jobs:
  generate-api:
    # 2. ‚ùóÔ∏è –í–∞–∂–Ω–æ: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª.
    # –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç - —ç—Ç–æ –∫–æ–º–º–∏—Ç –æ—Ç —Å–∞–º–æ–≥–æ –±–æ—Ç–∞.
    if: "!contains(github.event.head_commit.message, '[ci skip]')"
    
    runs-on: ubuntu-latest
    steps:
      # 3. –ó–∞–±–∏—Ä–∞–µ–º –∫–æ–¥ –∏–∑ 'master'
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          # –ù–∞–º –Ω—É–∂–µ–Ω –∫–æ–º–º–∏—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–ø—É—à–∏–ª–∏
          ref: ${{ github.sha }}

      # 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º uv
      - name: üîß Setup uv
        uses: astral-sh/setup-uv@v7

      # 5. –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
      - name: üêç Run API Generator
        run: ./tools/api-generator.py

      # 6. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
      - name: ü§ñ Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # 7. –ö–æ–º–º–∏—Ç–∏–º –∏ –ø—É—à–∏–º API —Ñ–∞–π–ª
      # —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –≤–µ—Ç–∫—É, –∫–æ–º–º–∏—Ç–∏–º –∏ –ø—É—à–∏–º –≤ –Ω–µ—ë
      - name: Create and push api-update branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b api-update-${{ github.run_id }}
          git add .
          git commit -m "Automated API update from workflow #${{ github.run_id }}" || echo "No changes to commit"
          git push origin api-update-${{ github.run_id }}
      
      # —Å–æ–∑–¥–∞—ë–º PR –∏–∑ —ç—Ç–æ–π –≤–µ—Ç–∫–∏ –≤ master
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: master
          branch: api-update-${{ github.run_id }}
          title: "Automated API update"
          body: "This PR updates generated API files."
          draft: false

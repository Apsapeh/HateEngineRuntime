name: üõ†Ô∏è Generate API on Master

on:
  # 1. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ –≤ 'master'
  # (–û–±—ã—á–Ω–æ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –º–µ—Ä–∂–∞ PR)
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  generate-api:
    # 2. ‚ùóÔ∏è –í–∞–∂–Ω–æ: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª.
    # –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç - —ç—Ç–æ –∫–æ–º–º–∏—Ç –æ—Ç —Å–∞–º–æ–≥–æ –±–æ—Ç–∞.
    if: "!contains(github.event.head_commit.message, '[ci skip]')"
    
    runs-on: ubuntu-latest
    steps:
      # 3. –ó–∞–±–∏—Ä–∞–µ–º –∫–æ–¥ –∏–∑ 'master'
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          # –ù–∞–º –Ω—É–∂–µ–Ω –∫–æ–º–º–∏—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–ø—É—à–∏–ª–∏
          ref: ${{ github.sha }}

      # 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º uv
      - name: üîß Setup uv
        uses: astral-sh/setup-uv@v7

      # 5. –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
      - name: üêç Run API Generator
        run: ./tools/api-generator.py

      # 6. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
      - name: ü§ñ Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # 7. –ö–æ–º–º–∏—Ç–∏–º –∏ –ø—É—à–∏–º API —Ñ–∞–π–ª
      - name: üìù Commit and Push generated API file
        run: |
          # ‚ùóÔ∏è –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞
          git add --force include/HateEngineAPI.h src/api_sym_lookup_table.h
          
          if ! git diff --staged --quiet; then
            echo "‚úÖ API file changed. Committing..."
            git commit -m "chore(api): Generate API header [ci skip]"
            
            # ‚ùóÔ∏è –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º HEAD:refs/heads/master –¥–ª—è –ø—É—à–∞ –∏–∑ detached HEAD
            echo "‚¨ÜÔ∏è Pushing to master..."
            git push origin HEAD:refs/heads/master
          else
            echo "ü§∑ No changes to API file. Skipping commit."
          fi
